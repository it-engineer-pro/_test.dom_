Вариант 3. SMB-сервер в составе домена AD 
На ОС Альт:
1. Ручная настройка контроллера домена Active Directory (Samba AD) на операционной системе «Альт Сервер» 10.1. Создание доменных учетных записей (пользователей)

1.1.	Подготовка к развертыванию контроллера домена

1.1.1 Обновление списка пакетов из репозиториев. 


Обновляю список пакетов до актуальных:
# apt-get update 

1.1.2. Установка необходимых компонент (пакетов) перед развёртыванием контроллера домена. Запуск необходимых служб


# apt-get install alterator-fbi
# systemctl start alteratord ahttpd
# systemctl enable alteratord ahttpd
# apt-get install alterator-net-domain task-samba-dc

После этого перезагружаем хост для корректной работы:
# reboot


1.1.3 Синхронизация времени с NTP-серверами. 

Состояние синхронизации времени осуществляю в вэб-интерфейсе альератора, который нужно запустить и добавить в автозагрузку:
# systemctl start alteratord ahttpd
# systemctl enable alteratord ahttpd
После этого, проверяю синхронизацию времени в вэб-интрефейсе ЦУС (обычно, в ЦУС, уже все установлено по умолчанию, но требуется поставить галочку для получения данных с сервера времени, как указано на рис. 1.1).
Синхронизация времени (NTP) – если не стоит по умолчанию, то настраиваем синхронизацию времени после установки соответствующего пакета:
# apt-get install alterator-datetime
# systemctl enable --now systemd-timesyncd
После этого в вэб-интерфейсе ЦУС альтератора появятся соответствующий пукнт «Дата и время», как это указано на рис. 1.1.


Рисунок 1.1 – Настройка синхронизации времени с NTP-сервером

Синхронизацию времени также можно сделать (осуществить), используя альтернативный сервис Crony, который считается лучшим (удобным) для unix-подобных систем считается сервис Crony:
# apt-get install chrony
# systemctl start chrony
# systemctl status chrony

1.2. Рекомендуемая настройка параметров сети 

 
Рекомендуется задать (но не обязательно) полное имя хоста в формате FQDN. Это упрощает создание домена с командной строки в интерактивном режиме. 
Домен поиска должен соответствовать имени будущего контроллера домена (test.dom), как это указано на рис.1.2.  
# hostnamectl set-hostname altsrv1.test.dom

Рисунок 1.2 - Ручные настройки параметров сетевого интерфейса, работающего по типу подключения «Внутренняя сеть», контроллера домена Active Directory (Samba AD)

После переименования имени хоста, нужно перезагрузить ОС.
Далее смотрим на содержание файла  /etc/resolv.conf
# cat /etc/resolv.conf
search test.dom
nameserver 127.0.0.1


Изменять имя хоста можно (лучше даже) путем редакции в системном файле /etc/sysconfig/network, откуда все службы берут имя хоста (рис.1.3).

Рисунок 1.3 - Изменение имени хоста в системном файле /etc/sysconfig/network, откуда все службы берут имя хоста.





 1.3. 	Создание домена Active Directory (Samba)


1.3.1.	Чистка конфигурации по умолчанию, полученной при первой установке операционной системы до создания домена

Согласно рекомендациям учебного материала по курсу «ALTSERV. Инфраструктурные службы в ОС Альт» осуществляю следующие действия:
- Удаляю конфликтующие службы
# systemctl stop smb nmb krb5kdc slapd bind dnsmasq
# systemctl disable smb nmb krb5kdc slapd bind dnsmasq

- Чистка старой конфигурации samba с созданием нужных каталогов
# rm -f /etc/samba/smb.conf
# rm -rf /var/lib/samba
# rm -rf /var/cache/samba
# mkdir -p /var/lib/samba/sysvol

1.3.2.	Создание домена Active Directory (Samba AD) с командной строки
# samba-tool domain provision --realm=test.dom --domain test --adminpass='netlab_123' --dns-backend=SAMBA_INTERNAL --server-role=dc --use-rfc2307

Рисунок 1.4 – Показ успешности создания домена test.dom
1.3.3.	Установка служб домена (samba) на автозапуск. Настройка переадресации на внешние DNS-сервера
# systemctl start samba
# systemctl enable samba
Содержание конфигурационного файла samba /etc/samba/smb.conf (должно быть переадресация DNS на внешние сервера DNS – в нашем случае на DNS-сервера компании «Гугл» по адресу 8.8.8.8) показано на рис. 1.5:

Рисунок 1.5 - Содержание конфигурационного файла samba /etc/samba/smb.conf

1.4. Настройка конфигурационного файла Kerberos
Рекомендуется выполнить настройку конфигурационного файла Kerberos по адресу /etc/krb5.conf. Все настройки во время настройки контроллера домена (хоть с командной строки или через ЦУС) автоматически записываются в файл /var/lib/samba/private/krb5.conf. Поэтому, рекомендуется скопировать настройки Kerberos с файла /var/lib/samba/private/krb5.conf на /etc/krb5.conf, что я и сделаю (предварительно оригинальный файл настройки Kerberos /etc/krb5.conf сохраняем под другим именем, на всякий случай):
# mv /etc/krb5.conf /etc/krb5.conf.default
# cp /var/lib/samba/private/krb5.conf /etc/krb5.conf
После этого рекомендуется перезапустить службу samba:
$  systemctl restart samba

1.5. Просмотр информации о домене. Проверка разрешения имен. Просмотр предоставляемых ресурсов samba

Просмотр информации о домене показано на рис. 1.6.
# samba-tool domain info 127.0.0.1

Рисунок 1.6 – Просмотр информации о домене (по команде samba-tool domain info 127.0.0.1)

DNS-сервер должен быть настроен на самого себя (см. рис. 1.7).

Рисунок 1.7 – Проверка разрешения имен (настройки DNS и поискового домена после настройки контроллера домена Active Directory (Samba AD))
Просмотр предоставляемых ресурсов samba осуществляется по команде (результат см. на рис. 1.8):
# smbclient -L localhost -U Administrator 


Рисунок 1.8 - Просмотр предоставляемых ресурсов samba после настройки контроллера домена Active Directory (Samba AD).

1.6. Добавление узла к домену

1.6.1. Настройка разрешения имен на узле до добавления в домен

Рекомендуется (но, не обязательно) хосты называть по полному имени в формате FQDN, где доменная часть FQDN должна быть как имя домена, в нашем случае test.dom:
# hostnamectl set-hostname altwks1.test.dom
(или редактируем системный файл /etc/sysconfig/network, откуда все службы берут имя хоста – см. выше, рис. 1.3.)
Обязательно перезагружаем хост после изменения имени!!!
Далее в настройках сетевого интерфейса нужно сделать, так, что поисковый домен должен быть как, созданный домен в контроллере домена Samba AD, в моем случае это test.dom. И DNS-сервер должен быть перенаправлен на контроллер домена (см. рис. 1.9), сохраняем настройки, перезагружаем ОС:

Рисунок 1.9 – Настройки сетевого интерфейса и разрешения имен на узле перед добавлением в домен.
Проверка разрешения имен перед добавлением  узла в домен (проверка аналогична, как в контроллере домена, см. рис. 1.10):
# smbclient -L altsrv1 -U Administrator
# host altsrv1.test.dom
# host -t SRV _kerberos._udp.test.dom
# host -t SRV _ldap._tcp.test.dom

Рисунок 1.10 – Проверка разрешения имен перед добавлением  узла в домен (проверка аналогична, как в контроллере домена)

1.6.2. Установка необходимых компонент к узлу, который будет добавлен в созданный домен на контроллере домена

По умолчанию в рабочих станциях уже стоит нужный пакет task-auth-ad-sssd, который необходим для успешного добавления узла в домен. Но, если этот пакет не установлен, то его необходимо установить по команде с терминала:
# apt-get install task-auth-ad-sssd





1.6.3. Добавление узла в домен через командную строку на клиентском хосте (altwks1)

Добавление узла в домен осуществляю через командную строку следующей командой:
# system-auth write ad test.dom altwks1 test 'administrator' 'netlab_123', 
где: 
test.dom – имя домена в контроллере домена;
test – рабочая группа;
administrator – администратор в контроллере домена;
netlab_123 – пароль администратора в контроллере домена.

В этом случае узел добавляется в домен, проверку, которого на узле проверяю командой system-auth status (см. рис. 1.11.), после чего перезагружаем ОС для возможности входа в систему под доменными учетными записями:


Рисунок 1.11 - Проверка корректности добавления узла в домен.

После добавления узла в домен, на этом хосте можно входить в систему под доменными пользователями, созданием которых займусь в следующем пункте ниже.

1.7. Управление пользователями/группами (samba-tool)

1.7.1. Создание доменных учетных записей в контроллере домена

Создаю посредством samba-tool две доменные учетные записи (пользователей) sambauser1 и  sambauser2 по следующим командам (см. рис. 1.13):
# samba-tool user create sambauser1 --given-name='Иван Иванов' --mail-address='ivanov@test.dom'
# samba-tool user create sambauser2 --given-name='Петр Петров' --mail-address='petrov@test.dom'
Пароль для sambauser1 и sambauser1 одинаковый, и равно Pa$$word.
Просмотр списка доменных учетных записей:
# samba-tool user list

Рисунок 1.13 - Создание доменных учетных записей в созданном контроле домена посредством утилиты samba-tool.

После создания доменных учетных записей (пользователей) нужно их разблокировать, чтобы можно было под этими учетными записями входить в систему (см. рис. 1.14):
# samba-tool user setexpiry sambauser1 --noexpiry
# samba-tool user setexpiry sambauser2 --noexpiry

Рисунок 1.14 - Разблокировка созданных доменных учетных записей для возможности в последующем зайти под этими учетными записями в систему.

Переходим к проверке возможности входа с клиентского узла под доменными учетными записями (рис. 1.15).



Рисунок 1.15 - Проверка возможности входа с клиентского узла под доменными учетными записями.


1.7.2. Создание групп посредством samba-tool

Создам группы sambagroup1 и sambagroup2 посредством использования samba-tool по следующим командам:
# samba-tool group add sambagroup1
# samba-tool group add sambagroup2



1.8. Управление пользователями/группами (alterator)
Необходимо установить следующие пакеты, и перезапустить альтератор для появления в вэб-интерфейсе альтератора еще 2 пунктов «пользователи» и «группы». Настройки указаны на рис. 1.16.
# apt-get install alterator-ldap-users alterator-ldap-groups netcmdplus
# systemctl restart ahttpd
На этом настройку контроллера домена Active Directory (Samba AD) и создание доменных пользователей заканчиваю. 
               
               
Рисунок 1.16 – Настройки доменных учетных записей в вэб-интрефейсе ЦУС, в альтераторе.
2. Добавление SMB-сервера на altsrv2 к домену на altsrv1
- Настройка разрешения имен на узле до добавления в домен
Рекомендуется (но, не обязательно) хосты называть по полному имени в формате FQDN, где доменная часть FQDN должна быть как имя домена, в нашем случае test.dom:
# hostnamectl set-hostname altsrv2.test.dom
(или редактируем системный файл /etc/sysconfig/network, откуда все службы берут имя хоста – см. выше, рис. 1.3.)
Обязательно перезагружаем хост после изменения имени!!!
Далее в настройках сетевого интерфейса нужно сделать, так, что поисковый домен должен быть как, созданный домен в контроллере домена Samba AD, в моем случае это test.dom. И DNS-сервер должен быть перенаправлен на контроллер домена (см. рис. 2.1), сохраняем настройки, перезагружаем ОС:


Рисунок 2.1 – Настройки сетевого интерфейса и разрешения имен на узле перед добавлением в домен.
Проверка разрешения имен перед добавлением  узла в домен (проверка аналогична, как в контроллере домена, см. рис. 2.2):
# smbclient -L altsrv1 -U Administrator
# host altsrv1.test.dom
# host -t SRV _kerberos._udp.test.dom
# host -t SRV _ldap._tcp.test.dom

Рисунок 2.2 – Проверка разрешения имен перед добавлением  узла в домен (проверка аналогична, как в контроллере домена)


- Установка необходимых компонент к узлу, который будет добавлен в созданный домен на контроллере домена

По умолчанию в рабочих станциях уже стоит нужный пакет task-auth-ad-sssd, который необходим для успешного добавления узла в домен. Но, если этот пакет не установлен, то его необходимо установить по команде с терминала:
# apt-get update
# apt-get install samba samba-common-tools task-auth-ad-sssd samba-client

- Добавление узла в домен через командную строку на клиентском хосте (altsrv2)
Добавление узла в домен осуществляю через командную строку следующей командой:
# system-auth write ad test.dom altsrv2 test 'administrator' 'netlab_123', 
где: 
test.dom – имя домена в контроллере домена;
test – рабочая группа;
administrator – администратор в контроллере домена;
netlab_123 – пароль администратора в контроллере домена.

В этом случае узел добавляется в домен, проверку, которого на узле проверяю командой system-auth status (см. рис. 2.3.), после чего перезагружаем ОС для возможности входа в систему под доменными учетными записями:

Рисунок 2.3 - Проверка корректности добавления узла в домен.

- Важно проверить успешность добавления в файл /etc/krb5.conf имени (реалма) домена (по умолчанию все добавляется во время добавления узла в домен) – рис. 2.4

Рис. 2.4


- Создание разделяемого ресурса (каталога) smbshare на SMB -сервере altsrv2 (рис. 2.5)
Редактируем конфигурационный файл SMB –сервера, прописываем туда раздел для разделяемого ресурса smbshare (в самом внизу, после секции [global], и остальные секции можно удалять, если не пользуемся), и проверяем синтаксис через testparm -s
# nano /etc/samba/smb.conf
# testparm -s



Рис. 2.5

- Запуск самбы SMB на сервере altsrv2 в составе домена altsrv1
# systemctl enable --now smb
# systemctl enable --now avahi-daemon


- Перезапускаем службу smb на SMB -сервере altsrv2 (рис. 2.6)
# systemctl restart smb
# systemctl status smb

Рис. 2.6
- Проверка доступности общих ресурсов  на SMB -сервере altsrv2 (рис. 2.7)

Рис. 2.7


- Добавляем доменного пользователя sambauser2 в контроллере домена altsrv1  в доменную группу «Domain Admins» (рис. 2.8)

Рис. 2.8

- Создаем каталог /srv/smbshare на SMB-сервере altsrv2, и передаем его во владение группу администратора домена  Administrator:'Domain Admins' (рис. 2.9)

Рис. 2.9
- На клиентском хосте altwks1 проверяем доступность разделяемого (общего) ресурса smbshare под локальным пользователем (рис. 2.10)

Рис. 2.10.
- В созданном каталоге /srv/smbshare на SMB-сервере altsrv2, переданный во владение группу администратора домена  Administrator:'Domain Admins', даем группе владельца права на запись в каталог /srv/smbshare с добавлением SGID-бита (рис. 2.11), после чего, члены группы  'Domain Admins' (sambauser2 является членом группы 'Domain Admins' – выше добавляли) будут иметь возможность записи в данный катал (рис. 2.11)

Рис. 2.11.

-  Теперь в клиентского узла altwks1, осуществляем вход под доменной учетной записью sambauser2, и убеждаемся, что разделяемый каталог /srv/smbshare доступен для чтения и записи (рис. 2.12)

Рис. 2.12.

-  Теперь в клиентского узла altwks1, осуществляем вход под доменной учетной записью sambauser1, и убеждаемся, что разделяемый каталог /srv/smbshare доступен только для чтения, и НЕ доступен для записи (рис. 2.13)


Рис. 2.13.

На этом все поставленные задачи можно считать выполненными!


